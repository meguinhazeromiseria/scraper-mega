name: ðŸŸ¢ MegaLeilÃµes - DomÃ­nio Completo

on:
  # ExecuÃ§Ã£o manual
  workflow_dispatch:
  
  # Cron automÃ¡tico - DIA SIM, DIA NÃƒO (dias Ã­mpares)
  schedule:
    # Dias 1,3,5,7,9,11,13,15,17,19,21,23,25,27,29,31 Ã s 5h UTC (2h BRT)
    - cron: '0 5 1,3,5,7,9,11,13,15,17,19,21,23,25,27,29,31 * *'

jobs:
  megaleiloes-scraper:
    name: ðŸŸ¢ MegaLeilÃµes - Scrape Completo
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: |
          pip install requests==2.31.0 beautifulsoup4==4.12.3 python-dotenv==1.0.1
          pip install supabase==2.3.4 groq==0.9.0
          pip install playwright==1.48.0
          playwright install chromium --with-deps
      
      - name: Run MegaLeilÃµes Scraper (DomÃ­nio Completo)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PYTHONPATH: ${{ github.workspace }}/scrapers
        run: |
          echo "========================================"
          echo "ðŸŸ¢ MEGALEILÃ•ES - DOMÃNIO COMPLETO"
          echo "========================================"
          echo "ðŸ“… InÃ­cio: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ‡§ðŸ‡· HorÃ¡rio Brasil: $(TZ='America/Sao_Paulo' date '+%Y-%m-%d %H:%M:%S BRT')"
          echo "========================================"
          echo ""
          echo "ðŸ”¥ Varrendo TODAS as categorias do MegaLeilÃµes:"
          echo "   â€¢ VeÃ­culos (6 subcategorias)"
          echo "   â€¢ ImÃ³veis"
          echo "   â€¢ Bens de Consumo"
          echo "   â€¢ Industrial"
          echo "   â€¢ Animais"
          echo "   â€¢ Outros"
          echo ""
          echo "========================================"
          
          cd scrapers/megaleiloes
          python scraper.py
          
          echo ""
          echo "âœ… MegaLeilÃµes concluÃ­do: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
      
      - name: Upload Data (Debug)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: megaleiloes-${{ github.run_number }}
          path: scrapers/megaleiloes/data/normalized/megaleiloes_*.json
          retention-days: 3
      
      - name: Generate Summary
        if: always()
        run: |
          echo "## ðŸŸ¢ MegaLeilÃµes - DomÃ­nio Completo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "**Modo:** Manual" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Modo:** Cron (automÃ¡tico dia sim/dia nÃ£o)" >> $GITHUB_STEP_SUMMARY
            echo "**FrequÃªncia:** Dias Ã­mpares (1,3,5,7...) Ã s 5h UTC (2h BRT)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**HorÃ¡rio UTC:** $(date -u '+%Y-%m-%d %H:%M')" >> $GITHUB_STEP_SUMMARY
          echo "**HorÃ¡rio Brasil:** $(TZ='America/Sao_Paulo' date '+%Y-%m-%d %H:%M')" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Categorias Processadas:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… VeÃ­culos:" >> $GITHUB_STEP_SUMMARY
          echo "  - Aeronaves" >> $GITHUB_STEP_SUMMARY
          echo "  - Barcos" >> $GITHUB_STEP_SUMMARY
          echo "  - CaminhÃµes" >> $GITHUB_STEP_SUMMARY
          echo "  - Carros" >> $GITHUB_STEP_SUMMARY
          echo "  - Motos" >> $GITHUB_STEP_SUMMARY
          echo "  - Ã”nibus" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ImÃ³veis" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Bens de Consumo" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Industrial" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Animais" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Outros" >> $GITHUB_STEP_SUMMARY