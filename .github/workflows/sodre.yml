name: ðŸŸ£ SodrÃ© Santoro - DomÃ­nio Completo

on:
  # ExecuÃ§Ã£o manual
  workflow_dispatch:
  
  # Cron automÃ¡tico - UMA VEZ POR SEMANA
  schedule:
    # Toda terÃ§a-feira Ã s 6h UTC (3h da manhÃ£ no Brasil)
    - cron: '0 6 * * 2'

jobs:
  sodre-scraper:
    name: ðŸŸ£ SodrÃ© Santoro - Scrape Completo
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: |
          pip install requests==2.31.0 beautifulsoup4==4.12.3 python-dotenv==1.0.1
          pip install supabase==2.3.4 groq==0.9.0
          pip install playwright==1.48.0
          playwright install chromium --with-deps
      
      - name: Run SodrÃ© Scraper (DomÃ­nio Completo)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PYTHONPATH: ${{ github.workspace }}/scrapers
        run: |
          echo "========================================"
          echo "ðŸŸ£ SODRÃ‰ SANTORO - DOMÃNIO COMPLETO"
          echo "========================================"
          echo "ðŸ“… InÃ­cio: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ‡§ðŸ‡· HorÃ¡rio Brasil: $(TZ='America/Sao_Paulo' date '+%Y-%m-%d %H:%M:%S BRT')"
          echo "========================================"
          echo ""
          echo "ðŸ”¥ Varrendo TODAS as categorias do SodrÃ©:"
          echo "   â€¢ VeÃ­culos (8 subcategorias)"
          echo "   â€¢ Materiais"
          echo "   â€¢ ImÃ³veis"
          echo "   â€¢ Sucatas"
          echo ""
          echo "========================================"
          
          cd scrapers/sodre
          python scraper.py
          
          echo ""
          echo "âœ… SodrÃ© concluÃ­do: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
      
      - name: Upload Data (Debug)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: sodre-${{ github.run_number }}
          path: scrapers/sodre/data/normalized/sodre_*.json
          retention-days: 3
      
      - name: Generate Summary
        if: always()
        run: |
          echo "## ðŸŸ£ SodrÃ© Santoro - DomÃ­nio Completo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "**Modo:** Manual" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Modo:** Cron (automÃ¡tico semanal)" >> $GITHUB_STEP_SUMMARY
            echo "**FrequÃªncia:** Toda terÃ§a-feira Ã s 6h UTC (3h BRT)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**HorÃ¡rio UTC:** $(date -u '+%Y-%m-%d %H:%M')" >> $GITHUB_STEP_SUMMARY
          echo "**HorÃ¡rio Brasil:** $(TZ='America/Sao_Paulo' date '+%Y-%m-%d %H:%M')" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Categorias Processadas:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… VeÃ­culos:" >> $GITHUB_STEP_SUMMARY
          echo "  - Carros" >> $GITHUB_STEP_SUMMARY
          echo "  - UtilitÃ¡rios Leves" >> $GITHUB_STEP_SUMMARY
          echo "  - Motos" >> $GITHUB_STEP_SUMMARY
          echo "  - Ã”nibus" >> $GITHUB_STEP_SUMMARY
          echo "  - Peruas" >> $GITHUB_STEP_SUMMARY
          echo "  - UtilitÃ¡rios Pesados" >> $GITHUB_STEP_SUMMARY
          echo "  - Vans Leves" >> $GITHUB_STEP_SUMMARY
          echo "  - CaminhÃµes" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Materiais" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ImÃ³veis" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Sucatas" >> $GITHUB_STEP_SUMMARY